---
title: "STAT 215A, Final Project: Classifying ciTBI in Youth"
author: "Mark Oussoren, Sahil Saxena, Hyunsuk Kim, Florica Constantine"
date: "12/3/2021"
output:
  pdf_document:
    number_sections: yes
    extra_dependencies: ["float"]
citation_package: biblatex
biblio-style: ieee
header-includes:
- \usepackage{subfig}
- \usepackage{placeins}
- \usepackage{float}
- \floatplacement{figure}{H}
---
```{r setup, echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE}
# set default knitr chunks
knitr::opts_chunk$set(
  echo = FALSE,  # don't print the code chunk
  warning = FALSE,  # don't print warnings
  message = FALSE,  # don't print messages
  cache = TRUE, # cache the data
  fig.width = 4,  # set default width of figures
  fig.height = 2.25,  # set default height of figures
  out.height = '75%',
  out.width = '75%', 
  fig.align = "center",  # always align figure in center
  fig.pos = "H")  # don't cache results
```

# Introduction

## Domain problem to solve

How can we best vet and/or improve the clinical decision rule for your given problem? Most importantly, the clinical decision rule should be highly predictive and minimize the amount of missed diagnoses (i.e. have a very high sensitivity). It should also be easy-to-use, using variables that clinicians can readily have access to when making their decisions. Finally, the interpretability of the rule helps to check whether its predictions will make sense for new patients and makes it easier to apply in new settings.

## Data collection

What are the most relevant data to collect to answer the question in (1)?

Ideas from experimental design (a subfield of statistics) and active learning (a subfield of machine learning) are useful here. The above question is good to ask even if the data has already been collected because understanding the ideal data collection process might reveal shortcomings of the actual data collection process and shed light on analysis steps to follow.

The questions below are useful to ask: How were the data collected? At what locations? Over what time period? Who collected them? What instruments were used? Have the operators and instruments changed over the period? Try to imagine yourself at the data collection site physically.

## Meaning

What does each variable mean in the data? What does it measure? Does it measure what it is supposed to measure? How could things go wrong? What statistical assumptions is one making by assuming things didnâ€™t go wrong? (Knowing the data collection process helps here.)

Meaning of each variable -- ask students to imagine being there at the ER and giving a Glasgow coma score, for example, and also a couple of variables -- ask students what could cause different values written down.

How were the data cleaned? By whom?

# Exploratory Data Analysis

Our data set initially consists of 43,399 patients under the age of 18 with mild head trauma evaluated in 25 PECARN emergency departments. In particular, we have 125 features filled out by trained site investigators and other emergency department physicians who recorded patient history, injury mechanism, and symptoms and signs on a standardized data form before knowing results along with the results recorded as 'PosIntTBI'. We first noticed that the data set had several variables that were not filled out - recorded as nans or np.nans. Below, we can see the fraction of missing data for each of the features. Notably, there are features "Dizzy" and "Ethnicity" that are missing in more than 35% of the points. Looking through the variable descriptions and speaking with the clinicians tells us that these are in fact not very relevant and very susceptible to change patient by patient. For these reasons, we end up dropping these variables. 

```{r, out.width = "450px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/missingness.png")
```

Next, as reality checks, we notice that there are 20 patients with the variable 'PosIntFinal', our desired outcome, missing however in the paper however, they claim only 18 are missing. This discrepency is noted, but not much else can be done. However in the related outcome variables which consist of "Intub24Head", "Neurosurgery", "HospHeadPosCT", and "DeathTBI", their union of missing/unknowns is only one which means at most one of the 20 outcomes cannot be inferred indirectly through these. As seen below, it turns out that we can infer all of these outcomes which results in no missing outcomes from our data set. Outside of this difference between our data and the paper, we can compare the GCSTotal scores. Notably we find that there 969 GCS scores that lie between 3 and 13 as described in the paper. As an aside from the paper comparison, we notice that the main continuous variable in our repertoire is the age. The age of patients from this dataset is plotted below, and we notice a very significant chunk of patients are two years old or younger. As seen in the paper, this split in frequency is also marked by not so similar distributions of the outcome hence why the paper partitions the dataset into two groups.

```{r, out.width = "250px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/age_dist.png")
```

To retrace back to our analysis of missing features, we would now like to shine some light on our judgement calls and the cleaning of the data. 

For starters, we sifted through the excel sheet containing variable names and descriptions and noticed that many variables list the category "Not applicable" as "No" or "Missing". To determine which variables exactly we could impute 'Not applicable' as "No", I simply match up those "Not applicable" ones that correspond with "No" in the parent question. For instance, we have "Seiz" which indicates if the patient had a seizure or not and many subsequent questions with "Not applicable" as a response. We find all of the "child" variables can be imputed as no because they all correspond to "No" in the "parent" variable. 
Next, we turn to impute the missing entries discussed earlier. These make up a very small percentage of the data as seen in the bar plot above. For this reason, we initially decided our judgement call would be to fill in these not described in the data description excel file with the most likely or mode. *Do I need more justification for this - it's a very small subset of our data?*

Finally, we pivot to discovering variables that may prove fruitful in determining whether or not a kid has ciTBI. First, we may simply analyze the features that are most correlated in absolute value to the outcome after one-hot encoding all of the variables and looking at Spearman's rho. Notably, all of the GCS (total, group, and sub rankings) alongside AMS ans SFxBas variables (and sub variables as these include multiple sub parts) are the most correlated with the outcome compared to the other features. 

```{r, out.width = "400px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/correlation.png")
```

Interestingly enough from the plot, if we remember from our earlier analysis of missing variables, the GCS sub features are more missing than the total and they both share very strong correlations to the outcome. To reconcile which are more important (as this is necessary in several classification models such as logistic regression), we plot the correlations of these correlated variables in the heat map below. From this analysis, it is clear that the GCS variables are correlated as indicative by the blues, however what is even more correlated is the string of AMS variables. Again, as discussed earlier, the questions with nested/follow ups move hand in hand with each other. This line of reasoning forms the basis for our initial data set for modeling - strip the data to only consist of those parent questions along with those that have no follow up questions but are still relevant. 

```{r, out.width = "350px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/heatmap.png")
```

Finally, to close our EDA we can pivot to a more sophisticated method for explaining our data - through PCA. 
In the first PC plot, we notice CTForm1 which determines if a CT was ordered or not contributes the most to PC1. In hindsight, this will obviously separate our outcome as it is typically decided after the decision is made. Thus, this variable along with several other will be removed for the sake of not biasing our rules.  

```{r, out.width = "200px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/ctform_pc.png")
```

In this latter PC plot, the second PC whose largest loading is OSI, which determines if another non-head substantial injury occurred. After speaking with the clinician, we decided that this variable while potentially giving of the outcome is most likely pre-CT and can thus be incorporated into our modeling.

```{r, out.width = "200px"}
knitr::include_graphics("/Users/marko/rule-vetting/rulevetting/projects/tbi_pecarn/notebooks/figs/osi_pc.png")
```

# Baseline Model

# Modeling

## Decision Trees
asdf.

## Logistic regression
asdf.

## Boosted Models (Ada & ..)
asdf.

## SVM (and Kernel SVM)
asdf.

# Conclusions
asdf.

## Division of Labor
asdf.

# References

